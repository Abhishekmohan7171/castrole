rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
      
      // Notifications sub-collection
      match /notifications/{notificationId} {
        // Users can only read their own notifications
        allow read: if isOwner(userId);
        
        // Users can update (mark as read) or delete their own notifications
        allow update, delete: if isOwner(userId);
        
        // Any authenticated user can create notifications for other users
        // This allows the system to send notifications
        allow create: if isAuthenticated();
      }
    }
    
    // Profiles collection
    match /profiles/{profileId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(profileId);
    }
    
    // Chat rooms
    match /chatRooms/{roomId} {
      // Users can read rooms they are participants in
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.participants;
      
      // Users can create rooms if they are one of the participants
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participants;
      
      // Users can update rooms they are participants in
      allow update: if isAuthenticated() && 
                       request.auth.uid in resource.data.participants;
      
      // Messages sub-collection
      match /messages/{messageId} {
        // Users can read messages in rooms they are participants in
        allow read: if isAuthenticated() && 
                       request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants;
        
        // Users can create messages in rooms they are participants in
        allow create: if isAuthenticated() && 
                         request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants &&
                         request.auth.uid == request.resource.data.senderId;
        
        // Users can update messages they sent (for read receipts, etc.)
        allow update: if isAuthenticated() && 
                         request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants;
      }
    }
    
    // User uploads
    match /userUploads/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
      
      match /{allChildren=**} {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId);
      }
    }
    
    // Block list
    match /blockList/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
      
      match /blocked/{blockedUserId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
